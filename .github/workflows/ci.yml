# name: CI Pipeline

# on:
#   push:
#     branches: [main, develop]
#     paths:
#       - "src/**"
#       - ".github/workflows/ci.yml"
#   workflow_dispatch: {}
#   pull_request:
#     branches: [main, develop]

# env:
#   PYTHON_VERSION: "3.10"

# jobs:
#   test:
#     name: Run Tests
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: "3.10"

#       - name: Cache pip packages
#         uses: actions/cache@v3
#         with:
#           path: ~/.cache/pip
#           key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
#           restore-keys: |
#             ${{ runner.os }}-pip-

#       - name: Install dependencies
#         run: |
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt
#           pip install pytest pytest-cov

#       - name: Create directories
#         run: |
#           mkdir -p artifacts/models artifacts/preprocessors artifacts/metrics
#           mkdir -p logs data/raw data/processed mlruns

#       - name: Run tests
#         run: |
#           pytest tests/ -v --cov=src --cov=api --cov-report=xml --cov-report=term || true

#       - name: Upload coverage
#         uses: codecov/codecov-action@v3
#         with:
#           file: ./coverage.xml
#           fail_ci_if_error: false
#         continue-on-error: true

#   lint:
#     name: Code Quality
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Set up Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: ${{ env.PYTHON_VERSION }}

#       - name: Install linting tools
#         run: |
#           pip install flake8 black isort mypy

#       - name: Run flake8
#         run: |
#           flake8 src/ api/ --count --select=E9,F63,F7,F82 --show-source --statistics
#           flake8 src/ api/ --count --max-complexity=10 --max-line-length=127 --statistics

#       - name: Check Black formatting
#         run: |
#           black --check src/ api/ streamlit_app/

#       - name: Check isort
#         run: |
#           echo "Ignore for now"
#         #   isort --check-only api/ src/ streamlit_app/

#       - name: Run mypy type checking
#         run: |
#           echo "Ignore for now"
#         #   mypy src/ --ignore-missing-imports --no-strict-optional
#         # continue-on-error: true

#   # security:
#   #   runs-on: ubuntu-latest
#   #   steps:
#   #     - name: Checkout repository
#   #       uses: actions/checkout@v4
#   #       with:
#   #         fetch-depth: 0

#   #     - name: Set up Python
#   #       uses: actions/setup-python@v4
#   #       with:
#   #         python-version: "3.11"

#   #     - name: Install Bandit and Safety
#   #       run: |
#   #         python -m pip install --upgrade pip
#   #         pip install bandit safety

#   #     - name: Run Bandit
#   #       run: |
#   #         mkdir -p security-output
#   #         bandit -r src -f json -o security-output/bandit.json || true

#   #     - name: Run Safety
#   #       run: |
#   #         pip install safety
#   #         safety check --full-report --json > security-output/safety.json || true

#   #     - name: Run Trivy (use official GitHub Action) to produce SARIF
#   #       # pin to a specific released version for reproducibility
#   #       uses: aquasecurity/trivy-action@0.28.0
#   #       with:
#   #         scan-type: "fs"
#   #         scan-ref: "."
#   #         format: "sarif"
#   #         output: "security-output/trivy-results.sarif"
#   #       continue-on-error: true

#   #     - name: Debug - Show security-output contents
#   #       if: always()
#   #       run: |
#   #         echo "Listing security-output:"
#   #         ls -la security-output || true
#   #         echo "---- first lines of trivy sarif (if present) ----"
#   #         head -n 60 security-output/trivy-results.sarif || echo "no trivy SARIF present"
#   #         echo "---- done ----"

#   #     - name: Check SARIF exists
#   #       id: check_sarif
#   #       run: |
#   #         if [ -f security-output/trivy-results.sarif ]; then
#   #           echo "sarif_exists=true" >> "$GITHUB_OUTPUT"
#   #         else
#   #           echo "sarif_exists=false" >> "$GITHUB_OUTPUT"
#   #         fi

#   #     - name: Upload SARIF to GitHub Code Scanning
#   #       if: ${{ steps.check_sarif.outputs.sarif_exists == 'true' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository) }}
#   #       uses: github/codeql-action/upload-sarif@v4
#   #       with:
#   #         sarif_file: security-output/trivy-results.sarif
#   #         token: ${{ secrets.GITHUB_TOKEN }}

#   #     - name: Upload security-output as artifact (always)
#   #       if: always()
#   #       uses: actions/upload-artifact@v4
#   #       with:
#   #         name: security-output
#   #         path: security-output

#   build-test:
#     name: Test Build
#     runs-on: ubuntu-latest
#     needs: [test, lint]

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Set up Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: ${{ env.PYTHON_VERSION }}

#       - name: Install dependencies
#         run: |
#           pip install -r requirements.txt

#       - name: Test imports
#         run: |
#           python -c "from src.pipeline.training_pipeline import TrainingPipeline; print('✓ Training pipeline import successful')"
#           python -c "from src.pipeline.prediction_pipeline import PredictionPipeline; print('✓ Prediction pipeline import successful')"
#           python -c "from api.main import app; print('✓ API import successful')"

#       - name: Check script executability
#         run: |
#           python scripts/train.py --help
#           echo "✓ Training script is executable"

#   notification:
#     name: Notify Results
#     runs-on: ubuntu-latest
#     # needs: [test, lint, security, build-test]
#     needs: [test, lint, build-test]

#     if: always()

#     steps:
#       - name: Check job status
#         run: |
#           if [ "${{ needs.test.result }}" == "failure" ] || [ "${{ needs.lint.result }}" == "failure" ] || [ "${{ needs.build-test.result }}" == "failure" ]; then
#             echo "❌ CI Pipeline Failed"
#             exit 1
#           else
#             echo "✅ CI Pipeline Passed"

#           fi
